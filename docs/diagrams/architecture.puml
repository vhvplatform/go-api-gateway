@startuml API Gateway Architecture
!define RECTANGLE class

skinparam componentStyle rectangle
skinparam backgroundColor #FEFEFE
skinparam component {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    ArrowColor #1976D2
}

title API Gateway - System Architecture

actor "Client" as client
actor "Admin" as admin

package "API Gateway Layer" {
    component "Gin HTTP Server" as server {
        [Request Router] as router
        [Middleware Stack] as middleware
        [Health Checks] as health
    }
    
    component "Middleware Components" {
        [Recovery] as recovery
        [Correlation ID] as correlation
        [Logger] as logger
        [Metrics] as metrics
        [Compression] as compression
        [Request Validation] as validation
        [Size Limit] as size
        [Timeout] as timeout
        [CORS] as cors
        [Rate Limiter] as ratelimit
        [JWT Auth] as auth
    }
    
    component "Core Services" {
        [Circuit Breaker] as breaker
        [Redis Cache] as cache
        [Health Checker] as healthchecker
    }
    
    component "Handlers" {
        [Auth Handler] as authhandler
        [User Handler] as userhandler
        [Tenant Handler] as tenanthandler
        [Notification Handler] as notifhandler
    }
}

package "Observability" {
    database "Prometheus" as prometheus
    database "Jaeger" as jaeger
    component "Metrics Exporter" as metricsexp
    component "Trace Exporter" as traceexp
}

package "Backend Microservices" {
    component "Auth Service" as authsvc #FFE0B2 {
        [gRPC Server] as authgrpc
    }
    
    component "User Service" as usersvc #FFE0B2 {
        [gRPC Server] as usergrpc
    }
    
    component "Tenant Service" as tenantsvc #FFE0B2 {
        [gRPC Server] as tenantgrpc
    }
    
    component "Notification Service" as notifsvc #FFE0B2 {
        [HTTP Server] as notifhttp
    }
}

database "Redis" as redis #FFCDD2
database "MongoDB" as mongodb #FFCDD2

' Client connections
client --> server : HTTP/HTTPS Requests
admin --> server : Admin Requests

' Middleware flow
server --> middleware
middleware --> recovery
recovery --> correlation
correlation --> logger
logger --> metrics
metrics --> compression
compression --> validation
validation --> size
size --> timeout
timeout --> cors
cors --> ratelimit
ratelimit --> auth

' Routing
auth --> router
router --> authhandler
router --> userhandler
router --> tenanthandler
router --> notifhandler

' Health checks
server --> health
health --> healthchecker
healthchecker --> authsvc : Health Check
healthchecker --> usersvc : Health Check
healthchecker --> tenantsvc : Health Check

' Core services
authhandler --> breaker : With Circuit Breaker
userhandler --> breaker
tenanthandler --> breaker
breaker --> cache : Check Cache
cache --> redis

' Handler to backend communication
authhandler --> authgrpc : gRPC
userhandler --> usergrpc : gRPC
tenanthandler --> tenantgrpc : gRPC
notifhandler --> notifhttp : HTTP

' Backend to storage
authsvc --> mongodb
usersvc --> mongodb
tenantsvc --> mongodb
notifsvc --> mongodb

' Observability
metrics --> metricsexp
metricsexp --> prometheus : Push Metrics
logger --> traceexp
traceexp --> jaeger : Push Traces

note right of middleware
  Middleware executes in order:
  1. Recovery (panic handler)
  2. Correlation ID
  3. Logger
  4. Metrics
  5. Compression (gzip)
  6. Request Validation
  7. Size Limit
  8. Timeout
  9. CORS
  10. Rate Limiter
  11. JWT Auth (protected routes)
end note

note right of breaker
  Circuit Breaker Pattern:
  - Monitors service health
  - Opens on 60% failure rate
  - Auto-recovery after timeout
  - Per-service isolation
end note

note right of cache
  Redis Caching:
  - Response caching
  - Configurable TTL
  - Optional (graceful degradation)
end note

@enduml
